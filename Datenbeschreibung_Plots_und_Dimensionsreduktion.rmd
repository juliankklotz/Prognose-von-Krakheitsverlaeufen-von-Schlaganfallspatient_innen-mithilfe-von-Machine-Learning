---
title: "Prognose von Krankheitsverläufen von Schlaganfallspatient_innen mithilfe von Machine Learning Methoden"
author: "Julian Klotz"
date: "26 9 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
#load("\pfad_fuer_Daten")
library(dplyr)
library(cluster)
library(ggplot2)
library(psych)
library(polycor)
library(caret)
```

Der zur Verfügung gestellte Workspace beinhaltet vier Dataframes:  
* datDE
* datEN
* namenDE
* namenEN 

und zwei Werte, "datumDerAufbereitung" (der Wert 31.08.2021) und zeilevels (1440 characters, von "00:00" - "23:59").

Wir werden im folgenden die Dataframes datDE und namenDE verwenden. Zuallererst begutachten wir die Sturkur der Variablen, die in den nachfolgenden Machine Learning Methoden verwendet werden. 

## Datenbeschreibung

Beginnend mit der ersten Variable, mit der Nummer "i25001", welche im anschluss unsere "Target-Variable" sein wird.


```{r}
namenDE["i25001",]
str(datDE[,"i25001"])
cat("Wir erhalten eine Na-Prozentrate von",100*(234378 - length(na.omit(datDE[,"i25001"])))/234278,"%")
```


Wir sehen, durch die Ausgabe des namenDE Dataframes, dass es sich um den MRS (Modified Ranking Score) bei Follow-up (nachträglichem Verifizieren).  Durch die Ausgabe des datDE Dataframes erkennen wir, dass diese Variable ein Faktor mit 7 Leveln, nämlich 0-6 ist. In der letzten Zeile wurde berechnet, dass diese Variable bei 72% der Observationen fehlt (NA ist).   

Nun beobachten wir die i10001 Variable.

```{r}
namenDE["i10001",]
str(datDE[,"i10001"])
cat("Wir erhalten eine Na-Prozentrate von",100*(234378 - length(na.omit(datDE[,"i10001"])))/234278,"%")
```

Die Variablen "i9001"-"i9012" werden wir gesammelt untersuchen, mittels der R-Funktion "paste()".

```{r}
nameni90er <- rbind(namenDE[paste("i900",as.character(1:9),sep=""),],namenDE[paste("i90",as.character(10:12),sep=""),])
nameni90er
i90er <- cbind(datDE[,paste("i900",as.character(1:9),sep="")],datDE[,paste("i90",as.character(10:12),sep="")])
str(i90er)
levels(datDE[,"i9006"])
```

Bei diesen Variablen handelt es sich um gesundheitliche Variablen wie Hypertonie, Diabetes mellitus, Vorinsult, Herzinfarkt. Durch die Analyse der Daten erkennt man, dass alle Variablen, außer i9006 (Vorhofflimmern) aus einem Faktor mit 3 Leveln bestehen, nämlich "Nein","Ja", und "Unbekannt".
Die Variable i9006 hingegen hat 5 Levels, nämlich "Nein", "Ja, bereits bekannt", "Unbekannt", "de novo (EKG)" und "Ja".  

Betrachten wir nun die NA-Rate, und statistischen Kennzahlen der einzelnen Variablen.

```{r}
i90er_stats <- cbind(nameni90er,c(1:12),c(1:12),c(1:12),c(1:12),c(1:12))

for(i in c(1:5,7:9)){
  i90er_stats[i,3] <- paste(round(100*(234378 - length(na.omit(datDE[,paste("i900",as.character(i),sep="")])))/234278,2),"%",sep="")
  i90er_stats[i,4] <- paste(round(mean(na.omit(datDE[,paste("i900",as.character(i),sep="")])=="Ja")*100,2),"%",sep ="")
  i90er_stats[i,5] <- paste(round(mean(na.omit(datDE[,paste("i900",as.character(i),sep="")])=="Nein")*100,2),"%",sep ="")
  i90er_stats[i,6] <- paste(round(mean(na.omit(datDE[,paste("i900",as.character(i),sep="")])=="Unbekannt")*100,2),"%",sep ="")
  i90er_stats[i,7] <- paste(levels(datDE[,paste("i900",as.character(i),sep="")]),collapse = ', ')
}

for(i in 6){
  i90er_stats[i,3] <- paste(round(100*(234378 - length(na.omit(datDE[,paste("i900",as.character(i),sep="")])))/234278,2),"%",sep="")
  i90er_stats[i,4] <- paste(round(mean(na.omit(datDE[,paste("i900",as.character(i),sep="")]) %in% c("de novo (EKG)","Ja","Ja, bereits bekannt"))*100,2),"%",sep ="")
  i90er_stats[i,5] <- paste(round(mean(na.omit(datDE[,paste("i900",as.character(i),sep="")])=="Nein")*100,2),"%",sep ="")
  i90er_stats[i,6] <- paste(round(mean(na.omit(datDE[,paste("i900",as.character(i),sep="")])=="Unbekannt")*100,2),"%",sep ="")
  i90er_stats[i,7] <- paste(levels(datDE[,paste("i900",as.character(i),sep="")]),collapse = ', ')
  }




for(i in c(10:12)){
  i90er_stats[i,3] <- paste(round(100*(234378 - length(na.omit(datDE[,paste("i90",as.character(i),sep="")])))/234278,2),"%",sep="")
  i90er_stats[i,4] <- paste(round(mean(na.omit(datDE[,paste("i90",as.character(i),sep="")])=="Ja")*100,2),"%",sep ="")
  i90er_stats[i,5] <- paste(round(mean(na.omit(datDE[,paste("i90",as.character(i),sep="")])=="Nein")*100,2),"%",sep ="")
  i90er_stats[i,6] <- paste(round(mean(na.omit(datDE[,paste("i90",as.character(i),sep="")])=="Unbekannt")*100,2),"%",sep ="")
  i90er_stats[i,7] <- paste(levels(datDE[,paste("i90",as.character(i),sep="")]),collapse = ', ')
}
names(i90er_stats) <- c("Variablen Code","Variablen Beschreibung","Rate fehlender Werte","relative Häufigkeit von 'Ja'*","relative Häufigkeit von 'Nein'","relative Häufigkeit von 'Unbekannt'","Kategorien") 
i90er_stats
```

Es ist klar ersichtlich, dass die Variable i9008 (PAVK) mit 44.25% Na.s am meisten fehlende Werte hat.

Nun ist die Frage, ob die NAs der einzelnen Variablen innerhalb der selben Observationen sind. Hierfür suchen wir die Observationen, in denen keine der i90er Variablen NAs haben, und berechnen wiederum die NA-Rate.

```{r}
100*(234378 - length(na.omit(i90er)$i9009))/234278
i90er_stats[i,3] <- 100*(234378 - length(na.omit(datDE[,paste("i90",as.character(i),sep="")])))/234278
```
Wir sehen, dass dieser Wert sehr nahe an den 44,25 der einzelnen Variable ist, womit man nun mit ungefähr 55% der Observationen rechnen kann.

## Tabelle aller qualitativen Variablen



```{r}
qual_var_names <- rbind(namenDE[c("i2005","i3005","i25001"),],nameni90er)
qual_var_stats <- cbind(qual_var_names,c(1:15),c(1:15),c(1:15),c(1:15),c(1:15))

for(i in c(1:15)){
  qual_var_stats[i,3] <- paste(round(100*(234378 - length(na.omit(datDE[,qual_var_names[i,1]])))/234278,2),"%",sep="")
  qual_var_stats[i,4] <- paste(round(mean(na.omit(datDE[,qual_var_names[i,1]])%in% c("Im Wachzustand","Männlich","de novo (EKG)","Ja","Ja, bereits bekannt","0","1","2"))*100,2),"%",sep ="")
  qual_var_stats[i,5] <- paste(round(mean(na.omit(datDE[,qual_var_names[i,1]])%in% c("Im Schlaf","Weiblich","Nein","3","4"))*100,2),"%",sep ="")
  qual_var_stats[i,6] <- paste(round(mean(na.omit(datDE[,qual_var_names[i,1]])%in% c("Unbekannt","5","6"))*100,2),"%",sep ="")
  qual_var_stats[i,7] <- paste(levels(datDE[,qual_var_names[i,1]]),collapse = ', ')
}

names(qual_var_stats) <- c("Variablen Code","Variablen Beschreibung","Rate fehlender Werte","relative Häufigkeit von 'Ja'*\\'Im Wachzustand'\\'Männlich'\\0-2","relative Häufigkeit von 'Nein'\\'Im Schlaf'\\'Weiblich'\\3-4","relative Häufigkeit von 'Unbekannt'\\5-6","Kategorien") 
qual_var_stats




```




```{r results='asis', echo=FALSE}
  library(xtable)
print(xtable(qual_var_stats),type = getOption("xtable.type", "latex"))
```
Nun beobachten wir noch die Variablen "i2005", "i3005", und "i4020" und Alter.

```{r}
namen4Var <- namenDE[c("i2005","i3005","i4020","Alter"),]
Var_NaRate <- cbind(namen4Var,NA_rate = c(1:4))
chars <- c("i2005","i3005","i4020","Alter")
for(i in c(1:4)){
  if (i==4){
    datDE_alt <- datDE %>%
      filter(Alter>=18)
    Var_NaRate[i,3] <- 100*(234378 - length(na.omit(datDE_alt[,chars[i]])))/234278
  }else {
  Var_NaRate[i,3] <- 100*(234378 - length(na.omit(datDE[,chars[i]])))/234278
  }
}
Var_NaRate

```


```{r}
datDE_boxplot <- datDE[,chars] %>%
  filter(Alter>=18,Alter <=120) %>%
  na.omit()

##männlich 1
datDE_boxplot_male <- datDE_boxplot %>%
         filter(i2005 == "Männlich")
mean(datDE_boxplot_male$Alter)
median(datDE_boxplot_male$Alter)
##weiblich 2
datDE_boxplot_female <- datDE_boxplot %>%
         filter(i2005 == "Weiblich")
mean(datDE_boxplot_female$Alter)
median(datDE_boxplot_female$Alter)

summary(datDE_boxplot)
```


```{r}
#prozent männlich
100145/(100145+89365)
```





### time variablen 


```{r}
require(stringr)
require(stringi)
#str_view(colnames(datDE), pattern = START %R% "time")
times <- colnames(datDE)[str_detect(colnames(datDE),"^time")]
```

```{r}
head(datDE[between(datDE[,times[1]],0,1440),times[1]])
```

```{r}
times_NaRate <- data.frame(cbind(times,namenDE[times,"DE"],c(1:length(times)),c(1:length(times)),c(1:length(times)),c(1:length(times))))

for (i in c(1:length(times))) {
  times_NaRate[i,3] <- paste(round((100*(234378 - length(na.omit(datDE[,times[i]])))+sum(na.omit(datDE[,times[i]])<0)+sum(na.omit(datDE[,times[i]])>1440))/234278,2),"%",sep="")
  times_NaRate[i,4] <- round(mean(datDE[between(datDE[,times[i]],0,1440),times[i]],na.rm=TRUE,trim=0.05),2)
  times_NaRate[i,5] <- round(mean(datDE[between(datDE[,times[i]],0,1440),times[i]],na.rm=TRUE),2)
  times_NaRate[i,6] <- quantile(datDE[between(datDE[,times[i]],0,1440),times[i]],na.rm=TRUE,probs=0.25)
  times_NaRate[i,7] <- quantile(datDE[between(datDE[,times[i]],0,1440),times[i]],na.rm=TRUE,probs=0.5)
  times_NaRate[i,8] <- quantile(datDE[between(datDE[,times[i]],0,1440),times[i]],na.rm=TRUE,probs=0.75)
  }

colnames(times_NaRate) <- c("Variablen Code","Variablen Beschreibung","Rate fehlender Werte","getrimmter Mittelwert (5%)","ungetrimmter Mittelwert","1. Quantil","Median (2. Quantil)","3.Quantil") 
times_NaRate
```

## Tabelle aller quantitativen Variablen



```{r}
lo_bound <- c(0,0,0,18,rep(0,length(times)))
up_bound <- c(rep(10000,3),120,rep(1440,length(times)))
quant_var_names <- c("jahr","i4020","i25001","Alter",times)
quant_stats <- data.frame(cbind(quant_var_names,namenDE[quant_var_names,"DE"],c(1:length(quant_var_names)),c(1:length(quant_var_names)),c(1:length(quant_var_names)),c(1:length(quant_var_names))))

quant_datDE <- datDE[,quant_var_names]
quant_datDE[,"i25001"] = as.integer(quant_datDE[,"i25001"])

for (i in c(1:length(quant_var_names))) {
  quant_stats[i,3] <- paste(round((100*(234378 - length(na.omit(quant_datDE[,quant_var_names[i]])))+sum(na.omit(!between(quant_datDE[,quant_var_names[i]],lo_bound[i],up_bound[i]))))/234278,2),"%",sep="")
  quant_stats[i,4] <- round(mean(quant_datDE[between(quant_datDE[,quant_var_names[i]],lo_bound[i],up_bound[i]),quant_var_names[i]],na.rm=TRUE,trim=0.05),2)
  quant_stats[i,5] <- round(mean(quant_datDE[between(quant_datDE[,quant_var_names[i]],lo_bound[i],up_bound[i]),quant_var_names[i]],na.rm=TRUE),2)
  quant_stats[i,6] <- quantile(quant_datDE[between(quant_datDE[,quant_var_names[i]],lo_bound[i],up_bound[i]),quant_var_names[i]],na.rm=TRUE,probs=0.25)
  quant_stats[i,7] <- quantile(quant_datDE[between(quant_datDE[,quant_var_names[i]],lo_bound[i],up_bound[i]),quant_var_names[i]],na.rm=TRUE,probs=0.5)
  quant_stats[i,8] <- quantile(quant_datDE[between(quant_datDE[,quant_var_names[i]],lo_bound[i],up_bound[i]),quant_var_names[i]],na.rm=TRUE,probs=0.75)
  }


names(quant_stats) <- c("Variablen Code","Variablen Beschreibung","Rate fehlender Werte","getrimmter Mittelwert (5%)","ungetrimmter Mittelwert","1. Quantil","Median (2. Quantil)","3.Quantil") 
quant_stats




qual_vec <- c("i2005","i3005")
quan_vec <- c()
```
```{}
  library(xtable)
write.csv2(quant_stats, file="quant_stats.csv")
write.csv2(qual_var_stats, file="qual_var_stats.csv")
  print(xtable(quant_stats),type = getOption("xtable.type", "latex"))
  
```


## Plots der Daten

```{r}
datDE_alt <- datDE %>%
  filter(Alter>=18,Alter<=120)

datDE_filt <- datDE_alt %>%
  filter(jahr %in% seq(2000,2021,1))

datDE_filt_alt <- datDE_filt %>%
  group_by(jahr) %>%
  summarise(Anzahl=length(na.omit(alter)),Mittelwert_Alter=mean(alter,na.rm=TRUE,trim=0.05))
ggplot() + geom_point(data=datDE_filt_alt, aes(x=jahr, y=Mittelwert_Alter, size=Anzahl))+ggtitle("Alter und Anzahl PatientInnen von 2000 bis 2021")+ylab("getrimmter Mittelwert des Alters")+xlab("Jahr")+theme_light()
```



```{r}
alt_group <- na.omit(datDE_filt[,c("i4020","i25001","Alter","i2005")])
brks_alter <- c(18,27,37,47,57,67,77,87,120)
alter_labels <- c("18-27","28-37","38-47","48-57","58-67","68-77","78-87","88-")
alt_group$Alter <- cut(alt_group$Alter,brks_alter,labels = alter_labels,include.lowest = TRUE)


alt_group_filt <- alt_group %>%
  group_by(Alter,i4020,i25001) %>%
  summarise(count=length(i2005))
```

Prozentuelle Häufigkeit der einzelnen Klassen der Target Variable berechnen und plotten.

```{r}
alt_group_filt2 <- alt_group %>%
  group_by(Alter,i4020) %>%
  summarise(count=length(i2005),cnt0 = sum(i25001==0)/length(i2005),cnt1=sum(i25001==1)/length(i2005),cnt2 = sum(i25001==2)/length(i2005),cnt3=sum(i25001==3)/length(i2005),cnt4 = sum(i25001==4)/length(i2005),cnt5=sum(i25001==5)/length(i2005),cnt6 = sum(i25001==6)/length(i2005))
```

```{r}
maxindex <- apply(alt_group_filt2[,4:10],1,which.max)
maxwert <- apply(alt_group_filt2[,4:10],1,max)
alt_group_filt2$i25001maxindex <- maxindex-1
alt_group_filt2$i25001maxwert <- maxwert
alt_group_filt2$i25001maxindex <- factor(as.integer(alt_group_filt2$i25001maxindex))
```


```{r}
names(alt_group_filt2[,"i25001maxindex"])<-"Gesundheitszustand bei Follow up"
ggplot() + geom_point(data=alt_group_filt2, aes(x=i4020, y=Alter,color = i25001maxindex,alpha=maxwert,size=count))+ggtitle("Grafik nach Alter, Schweregrad\nund Gesundheitszustand bei Nachverfolgung")+xlab("Schweregrad des Schlaganfalles (NIHSS)")+ylab("Alter")+theme_light()+labs(
  colour = "Häufigste Gesundheitszustand\nbei Nachverfolgung",
  size = "Anzahl der Patienten*innen",
  alpha = "Prozentueler Anteil\ndes häufigsten Gesundheitszustandes"
)+scale_alpha_continuous(breaks=c(0.5,1),labels=c("0.5","1.0"))+theme(legend.spacing=unit(0,"cm"))

```


## Dimensionsreduktion und Preprocessing



### time variablen

Es werden nur Observationen betrachtet, in denen die Zeitabstände zwischen 0 und 1440 Minuten (1 Jahr) sind.

Es wird eine EFA verwendet, um pro 'Faktor' die einflussreichsten Variable (mit dem größten Faktor Loading) zu beobachten und diese dann im weiteren zu verwenden und alle anderen Zeitvariablen zu weg zu lassen.

```{r}
datDE_time <- datDE %>%
  dplyr::select(starts_with("time"))
datDE_time <- datDE_time %>%
  dplyr::select(timeE_K:timeE_L,timeE_E,timeE_F)%>%
  filter(if_all(starts_with("time"),~.<1440),if_all(starts_with("time"),~.>0)) %>%
  na.omit()
  
head(datDE_time)
str(datDE_time)
cor_time <- cor(datDE_time)
scree(cor_time,factors=FALSE)
```

```{r}
CFA_time <- fa(r = cor_time, nfactors = 4, n.obs = nrow(datDE_time), rotate = "varimax")
CFA_time
```


```{r}
load_matr_time <- CFA_time$loadings
for (i in 1:9){
  for(j in 1:4){
    if (abs(load_matr_time[i,j])<0.24){
      load_matr_time[i,j]=0
    }
  }
}

```


```{r}
load_matr_t <- data.frame(matrix(as.numeric(load_matr_time), attributes(load_matr_time)$dim, dimnames=attributes(load_matr_time)$dimnames))
```

```{r}
library(xtable)
print(xtable(as.matrix(load_matr_t)),type = getOption("xtable.type", "latex"))
load_matr_t
```


Im Folgenden werden nun die Zeit-Variablen E_K,K_S und K_B verwendet, da sie den meisten einfluss auf die jeweiligen Faktoren haben.

### Gewohnheits-, Gesundheitsvariablen und Alter

Nun wird die Dimension der Gewohnheits-, Gesundheitsvariablen und die Altersvariable veringert, indem korrelierende Variablen zu Faktoren oder Cluster zusammengefasst werden. Zunächst müssen die Daten der entsprechenden Variablen gereinigt werden, um verwendbar zu sein. Dieser Schritt wird Preprocessing genannt, und in folgendem Absatz beschrieben.

#### Preprocessing 

Zunächst wird ein "random seed" gewählt, um die Zufälligkeit reproduzierbar zu machen. Dieser wird beliebig auf die Zahl 3000 gesetzt.

```{r}
set.seed(3000)
cl_var <- cbind(i90er,i10001 = datDE[,"i10001"],alter = datDE[,"Alter"])
cl_var <- cl_var %>%
  filter(alter>=18,alter <=120)
cl_var_na <- na.omit(cl_var)

```

Bei den Observationen ohne fehlenden Werten obiger Variablen fällt auf, dass das Ereignis Vorhofflimmern (Code i9006) nicht mehr die Ausgänge "de novo (EKG)" und "Ja, bereits bekannt" beinhaltet. Der Ausgang "Ja" kommt jedoch mit einer ähnlichen Häufigkeit vor, wie zuvor alle drei Ausgänge zusammen, nämlich jetzigen 25,66% mit zuvorigen 25.73%. 

```{r}
mean(cl_var_na[,"i9006"]=="de novo (EKG)")
mean(cl_var_na[,"i9006"]=="Ja, bereits bekannt")
mean(cl_var_na[,"i9006"]=="Ja")
```

```{r}
cl_var_na$id <- row.names(cl_var_na)
n_row <- nrow(cl_var_na)
shuffle_row <- sample(nrow(cl_var_na))
cl_var_shuffled <- cl_var_na[shuffle_row,]
split <- round(seq(0,1,0.05)*n_row)
```


```{r}
cl_var_bin <- cl_var_shuffled
brks_nihss <- c(0,4,10,20,42)
nihss_labels <- c("0-4","5-10","11-20","21-42")
brks_alter <- c(18,60,70,80,90,120)
alter_labels <- c("18-60","61-70","71-80","81-90","90-")
cl_var_bin$Alter <- cut(cl_var_bin$alter,brks_alter,labels = alter_labels,include.lowest = TRUE)
head(cl_var_bin$Alter,n=10)
str(cl_var_bin$Alter)
head(cl_var_bin)
```


Nun versuchen wir, die Variablen in Boolean Variablen zu modifizieren. Für Gesundheits und Gewohnheits Variablen wird "Ja" als 1 gesetzt, und "Unbekannt", sowie "Nein" als 0. Für die Variable, die das Alter beschreibt wird one hot encoding verwendet, wobei aufgrund der fehlenden Signifikanz die Alters Varible als geordnete kategoriale Variable im Weiteren verwendet wird.


```{r}

m <- model.matrix(~ 0 + i9001, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9002, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9003, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9004, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9005, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9006, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9007, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9008, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9009, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9010, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9011, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i9012, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + i10001, cl_var_shuffled)
cl_var_bin <- cbind(cl_var_bin[,-1],m)

m <- model.matrix(~ 0 + Alter, cl_var_bin)
cl_var_bin <- cbind(cl_var_bin[,-c(1,3)],m)


cl_var_bin_clean <- cl_var_bin[,-(c(1,3,4,6,7,9,10,12,13,15,16,17,18,19,21,23,24,26,27,29,30,32,33,35,36,38,39,41)+1)]
```


```{r}
cl_var_bin_alt_ord <- data.frame(sapply(cl_var_bin_clean[,-1],as.logical))
cl_var_bin_alt_ord <- cl_var_bin_alt_ord[,-c((ncol(cl_var_bin_alt_ord)-4):ncol(cl_var_bin_alt_ord))]
cl_var_bin_alt_ord$Alter <- cl_var_shuffled$alter
brks_alter <- c(18,60,70,80,90,120)
alter_labels <- c("18-60","61-70","71-80","81-90","90-")
cl_var_bin_alt_ord$Alter <- cut(cl_var_bin_alt_ord$Alter,brks_alter,labels = alter_labels,include.lowest = TRUE)
cl_var_bin_alt_ord$Alter <- factor(cl_var_bin_alt_ord$Alter,ordered=TRUE)
cl_var_bint <- sapply(cl_var_bin,as.integer)
head(cl_var_bin_alt_ord)
```

#### Heatmap (Plot)

```{r}
cor_alle <- hetcor(cl_var_bin_alt_ord)$cor
```

```{r}
heatmap(cor_alle,Colv=NA, Rowv=NA)
```



Je dunkler, bzw. roter das Feld, umso mehr korrellieren die beiden Variablen in der jeweiligen Spalte und Zeile miteinander. Man sieht, dass die Variablen i9009-i9012 stark korrelieren, sowie die restlichen Variablen auch miteinander korrelieren.
Da die Variablen i9009-i9012 nicht durch einen Faktor signifikant repräsentiert wurden, wurden alle anderen Variablen zur Faktorenanalyse verwendet.

Wie in der Arbeit beschrieben, kam traf eine Clusteringanalyse auf zu viele Schwierigkeiten beziehungsweise Probleme, weswegen die Faktorenanalyse als Dimensionsreduktion verwendet wurde, und signifikante Ergebnisse erzielte.

### Faktorenanalyse


#### Datensatz teilen für explorative und konfirmative Faktorenanalyse

Da die Variablen i9009-i9012 nicht durch einen Faktor signifikant repräsentiert wurden, wurden alle anderen Variablen zur Faktorenanalyse verwendet.

```{r}
splitval = round(0.5*nrow(cl_var_bin_alt_ord))

bin_alt_ord_i0X <- cl_var_bin_alt_ord[,-c(9:12)]


alt_ord_i0X_efa <- bin_alt_ord_i0X[1:splitval,]
alt_ord_i0X_cfa <- bin_alt_ord_i0X[(splitval+1):nrow(bin_alt_ord_i0X),]

```

#### Explorative Faktorenanalyse

Hierbei wird versucht, herauszufinden, wie viele zugrunde liegende Faktoren existieren. 

```{r}
cor_het_i0X_efa <-  hetcor(alt_ord_i0X_efa)$cor
scree(cor_het_i0X_efa,factors=FALSE)
```

Da vier Faktoren Eigenwerte über 1 haben, werden vier Faktoren zur Berechnung der Faktorladung, und der Signifikanz der Faktoren verwendet.

#### Konfirmative Faktorenanalyse

```{r}
cor_het_i0X_cfa <- hetcor(alt_ord_i0X_cfa)$cor
CFA_model_i0X_cfa <- fa(r = cor_het_i0X_cfa, nfactors = 4, n.obs = nrow(alt_ord_i0X_cfa), rotate = "varimax")
CFA_model_i0X_cfa
```

Durch den Tucker Lewis Index, sowie den RSMEA lässt sich herausstellen, dass die 4 Faktoren signifikant die Variablen beschreiben.

Nun werden nur die signifikanten Faktor Loadings, mit einem Wert über 0,3 zur Definition der Faktoren herangezogen. Diese werden dann mit der Daten Matrix multipliziert, um die Werte für die ensprechenden Faktoren zu erhalten.

```{r}
str(CFA_model_i0X_cfa$loadings)
load_matr_i0X <- CFA_model_i0X_cfa$loadings
for (i in 1:10){
  for(j in 1:4){
    if (abs(load_matr_i0X[i,j])<0.3){
      load_matr_i0X[i,j]=0
    }
  }
}

loaded_fact_ord_i0X <- as.matrix(sapply(alt_ord_i0X_cfa,as.integer))%*%load_matr_i0X

```


```{r}
load_matr <- data.frame(matrix(as.numeric(load_matr_i0X), attributes(load_matr_i0X)$dim, dimnames=attributes(load_matr_i0X)$dimnames))
```

```{r}
library(xtable)
print(xtable(as.matrix(load_matr)),type = getOption("xtable.type", "latex"))
head(load_matr_i0X,n=30)
```


### ML Methoden

#### Variablenselektion und Inklusion der Faktoren


Zur Vorhersage der Variable i25001 (MRS bei Follow-Up, Gesundheisscore zwischen 0 und 6), werden die drei selektierten Zeitintervall Variablen timeE_K, timeK_S, timeK_B, sowie die 4 Faktoren, welche aus der zuvorigen Faktorenanalyse der Gesundheits- und Gewohnheitsvariablen, sowie der Altersvariablen resultierten, als auch die Variablen i2005 (Geschlecht), i3005 (Ereignis aufgetreten), jahr (entsprechendes Jahr, dass zu dem Fall gezählt wird) und i4020 (NIHSS, Schweregrad des Schlaganfalles) verwendet.


 
 
```{r}
vec <- c("i2005","i3005","jahr","i4020","i25001","timeE_K","timeK_S","timeK_B")

ml_daten <- datDE[,vec]
ml_daten <- ml_daten %>%
filter(if_all(starts_with("time"),~.<1440),if_all(starts_with("time"),~.>0)) %>%
  na.omit()



ml_daten$id <- row.names(ml_daten)

id_i90er <- row.names(cl_var_bin_clean[(1+splitval):nrow(cl_var_bin_clean),])
str(id_i90er)
loaded_fact_ord_i0X_id <- cbind(loaded_fact_ord_i0X,id = id_i90er)
ml_daten <- merge(ml_daten,loaded_fact_ord_i0X_id,by="id")
ml_daten$id <- as.integer(ml_daten$id)
ml_daten <- ml_daten %>%
  arrange(id)
rownames(ml_daten) <- ml_daten$id
ml_daten <- ml_daten[,-1]
str(ml_daten)
head(ml_daten,n=50)
```

Mit den resultierenden Daten wird ein CSV erstellt, dass anschließend vom Python Programm geöffnet und weiter bearbeitet wird.

```{r}
write.csv(ml_daten,"ml_daten_12.csv")
```




## Appendix mit weiteren Methoden

### Dimensionsreduktion

Wie vorab beschrieben wurde Clustering als Dimensionsreduktionsmethode erwägt. Hierbei gab es jedoch das Problem, dass um eine Distanzmatrix zu erstellen eine geeignete Distanz für gemischte Datensätze verwendet werden muss. In der Arbeit wurde beschrieben, dass sich hierfür die Gower-Distanz eignet. Da diese jedoch ein Größenlimit für Datensätze hat, war man gezwungen den Datensatz aufzuteilen. Dies erfolgte zufällig, jedoch konnte zwischen den einzelnen Teildatensätzen insgesamt keine gemeinsame signifikante Cluster Struktur herausgefunden werden.

Bei diesem Code würde ein Error entstehen, dewegen wird dieser nicht automatisch ausgeführt, und der Datensatz geteilt:
```{}
gower_error <- daisy(cl_var_shuffled,metric = "gower")
```

#### Clustering (bis Zeile 1000)

Zunächst definieren wir eine Funktion, um ein 99%-Konfidenzintervall zu erstellen.

```{r}
confbound <- function(p,n,m) {
   if (m=="upper") {
   vz <- 1
   } else if (m=="lower") {
   vz <- -1
   }
   else {exit()}
   
      p+vz*2.576*sqrt((p*(1-p))/n)
}
```

Die Variable cut gibt die anzahl an Cluster wieder. Im folgenden werden alle Subsamples mit 2-4 Clustern miteinander verglichen. Hierfür wird pro Variable ein erstellt, der den Mittelwert, und eine Ober- und Untergrenze eines 99% Konfidenzintervall angibt. Die größte Untergrenze eines Clusters definiert dabei eine helle horizontale Linie, wobei die kleinste Obergrenze eine dunkle horizontale Linie erstellt. Wenn bei allen Variablen die dunklen Linien über den hellen Linien sind, könnte man die Subsamples zusammenfassen, und behaupten, dass universelle Cluster gefunden wurden, die sich auf die Grundgesamtheit anwenden lassen. Da dies jedoch bei keiner Variable mit keiner bestimmten Anzahl an Clustern der Fall ist, kann keine allgemeine Aussage getroffen werden.



```{r}
cl_var_shuffled <- cl_var_shuffled[,c(1:14)]
cut = 2
cnt2_wrd <- matrix(c(1:(cut*20*39)),byrow=TRUE,nrow=(20*cut))
for (i in 1:20){
gower_cl_var <- daisy(cl_var_shuffled[(split[i]+1):split[i+1],],metric = c("gower"))
cluster_gower <- hclust(gower_cl_var, method = "ward.D")

cluster_assignments <- cutree(cluster_gower,k=cut)

cl_var_clustered <- cl_var_shuffled[(split[i]+1):split[i+1],]
cl_var_clustered <- mutate(cl_var_clustered,cluster=cluster_assignments)

cnt_tmp <- cl_var_clustered %>%
group_by(cluster) %>%
summarise(count_cluster=length(alter),mean_alter=mean(alter), mean_i9001=mean(i9001=="Ja"),mean_i9002=mean(i9002=="Ja"),mean_i9003=mean(i9003=="Ja"),mean_i9004=mean(i9004=="Ja"),mean_i9005=mean(i9005=="Ja"),mean_i9007=mean(i9007=="Ja"),mean_i9008=mean(i9008=="Ja"),mean_i9009=mean(i9009=="Ja"),mean_i9010=mean(i9010=="Ja"),mean_i9011=mean(i9011=="Ja"),mean_i9012=mean(i9012=="Ja"),mean_i10001=mean(i10001=="Ja"))  %>%
mutate(u_i9001 = confbound(mean_i9001,count_cluster,"upper"),l_i9001 = confbound(mean_i9001,count_cluster,"lower"),u_i9002 = confbound(mean_i9002,count_cluster,"upper"),l_i9002 = confbound(mean_i9002,count_cluster,"lower"),u_i9003 = confbound(mean_i9003,count_cluster,"upper"),l_i9003 = confbound(mean_i9003,count_cluster,"lower"),u_i9004 = confbound(mean_i9004,count_cluster,"upper"),l_i9004 = confbound(mean_i9004,count_cluster,"lower"),u_i9005 = confbound(mean_i9005,count_cluster,"upper"),l_i9005 = confbound(mean_i9005,count_cluster,"lower"),u_i9007 = confbound(mean_i9007,count_cluster,"upper"),l_i9007 = confbound(mean_i9007,count_cluster,"lower"),u_i9008 = confbound(mean_i9008,count_cluster,"upper"),l_i9008 = confbound(mean_i9008,count_cluster,"lower"),u_i9009 = confbound(mean_i9009,count_cluster,"upper"),l_i9009 = confbound(mean_i9009,count_cluster,"lower"),u_i9010 = confbound(mean_i9010,count_cluster,"upper"),l_i9010 = confbound(mean_i9010,count_cluster,"lower"),u_i9011 = confbound(mean_i9011,count_cluster,"upper"),l_i9011 = confbound(mean_i9011,count_cluster,"lower"),u_i9012 = confbound(mean_i9012,count_cluster,"upper"),l_i9012 = confbound(mean_i9012,count_cluster,"lower"),u_i10001 = confbound(mean_i10001,count_cluster,"upper"),l_i10001 = confbound(mean_i10001,count_cluster,"lower")) %>%
arrange(desc(mean_alter))
  
cnt2_wrd[2*i-1,]<-as.double(cnt_tmp[1,])
cnt2_wrd[2*i,]<-as.double(cnt_tmp[2,])

}
colnames(cnt2_wrd)<-names(cnt_tmp)
```

```{r}
plot(cluster_gower,
     main = "Agglomerative with complete linkages")
```


```{r}
cnt2_wrd_plus <- cbind(rep(c(1:20),each=2),rep(1:2,20),cnt2_wrd)
colnames(cnt2_wrd_plus) <-c("sample","cluster_sort",colnames(cnt2_wrd))
cnt2_wrd_plus[1:6,]
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9001,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9001)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9001)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9001)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9001)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9001,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9001)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9001)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9001)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9001)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9002,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9002,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9002,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9002)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9002)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9002)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9002)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9003,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9003,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9003,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9003)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9003)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9003)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9003)), linetype="dashed", color = "red") 
```


```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9004,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9004,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9004,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9004)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9004)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9004)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9004)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9005,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9005,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9005,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9005)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9005)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9005)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9005)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9007,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9007,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9007,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9007)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9007)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9007)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9007)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9008,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9008,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9008,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9008)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9008)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9008)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9008)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9009,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9009,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9009,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9009)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9009)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9009)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9009)), linetype="dashed", color = "red") 
```


```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9010,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9010,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9010,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9010)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9010)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9010)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9010)), linetype="dashed", color = "red") 
```

```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9011,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9011,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9011,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9011)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9011)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9011)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9011)), linetype="dashed", color = "red") 
```

```{r}
cnt_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9012,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9012,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9012,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9012)), linetype="dashed", color = "green") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df$l_i9012), linetype="dashed", color = "red") +    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9012)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9012)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9012)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9012)), linetype="dashed", color = "red") 
```



```{r}
p <- ggplot(cnt_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i10001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i10001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i10001,color=factor(cluster_sort)))+
   geom_hline(yintercept=min(cnt_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i10001)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i10001)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i10001)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i10001)), linetype="dashed", color = "red") 
```
Nun mit 3 clustern

```{r}
cut = 3
cnt2_wrd <- matrix(c(1:(cut*20*39)),byrow=TRUE,nrow=(20*cut))
for (i in 1:20){
gower_cl_var <- daisy(cl_var_shuffled[(split[i]+1):split[i+1],],metric = c("gower"))
cluster_gower <- hclust(gower_cl_var, method = "ward.D")
cluster_assignments <- cutree(cluster_gower,k=cut)

cl_var_clustered <- cl_var_shuffled[(split[i]+1):split[i+1],]
cl_var_clustered <- mutate(cl_var_clustered,cluster=cluster_assignments)

cnt_tmp <- cl_var_clustered %>%
group_by(cluster) %>%
summarise(count_cluster=length(alter),mean_alter=mean(alter,trim=0.025), mean_i9001=mean(i9001=="Ja"),mean_i9002=mean(i9002=="Ja"),mean_i9003=mean(i9003=="Ja"),mean_i9004=mean(i9004=="Ja"),mean_i9005=mean(i9005=="Ja"),mean_i9007=mean(i9007=="Ja"),mean_i9008=mean(i9008=="Ja"),mean_i9009=mean(i9009=="Ja"),mean_i9010=mean(i9010=="Ja"),mean_i9011=mean(i9011=="Ja"),mean_i9012=mean(i9012=="Ja"),mean_i10001=mean(i10001=="Ja"))  %>%
mutate(u_i9001 = confbound(mean_i9001,count_cluster,"upper"),l_i9001 = confbound(mean_i9001,count_cluster,"lower"),u_i9002 = confbound(mean_i9002,count_cluster,"upper"),l_i9002 = confbound(mean_i9002,count_cluster,"lower"),u_i9003 = confbound(mean_i9003,count_cluster,"upper"),l_i9003 = confbound(mean_i9003,count_cluster,"lower"),u_i9004 = confbound(mean_i9004,count_cluster,"upper"),l_i9004 = confbound(mean_i9004,count_cluster,"lower"),u_i9005 = confbound(mean_i9005,count_cluster,"upper"),l_i9005 = confbound(mean_i9005,count_cluster,"lower"),u_i9007 = confbound(mean_i9007,count_cluster,"upper"),l_i9007 = confbound(mean_i9007,count_cluster,"lower"),u_i9008 = confbound(mean_i9008,count_cluster,"upper"),l_i9008 = confbound(mean_i9008,count_cluster,"lower"),u_i9009 = confbound(mean_i9009,count_cluster,"upper"),l_i9009 = confbound(mean_i9009,count_cluster,"lower"),u_i9010 = confbound(mean_i9010,count_cluster,"upper"),l_i9010 = confbound(mean_i9010,count_cluster,"lower"),u_i9011 = confbound(mean_i9011,count_cluster,"upper"),l_i9011 = confbound(mean_i9011,count_cluster,"lower"),u_i9012 = confbound(mean_i9012,count_cluster,"upper"),l_i9012 = confbound(mean_i9012,count_cluster,"lower"),u_i10001 = confbound(mean_i10001,count_cluster,"upper"),l_i10001 = confbound(mean_i10001,count_cluster,"lower")) %>%
arrange(desc(mean_alter))
  
cnt2_wrd[3*i-2,]<-as.double(cnt_tmp[1,])
cnt2_wrd[3*i-1,]<-as.double(cnt_tmp[2,])
cnt2_wrd[3*i,]<-as.double(cnt_tmp[3,])
}
colnames(cnt2_wrd)<-names(cnt_tmp)
```
```{r}
cnt2_wrd_plus <- cbind(rep(c(1:20),each=3),rep(1:3,20),cnt2_wrd)
colnames(cnt2_wrd_plus) <-c("sample","cluster_sort",colnames(cnt2_wrd))
cnt2_wrd_plus[1:6,]
```

## Plot (Dendogramm)

```{r}
plot(cluster_gower,main="Hierarchisches Clustering (agglomerativ) mit drei Clustern")
rect.hclust(cluster_gower , k = 3, border = 2:6)
abline(h = 3, col = 'red')
```


```{r}
cnt2_wrd_plus_df <- as.data.frame(cnt2_wrd_plus)
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9012,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9012,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9012,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9012)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9012)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9012)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9012)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9012)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9012)), linetype="dashed", color = "blue") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9001,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9001)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9001)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9001)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9001)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9001)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9001)), linetype="dashed", color = "blue") 
```
## Plot

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9002,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9002,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9002,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9002)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9002)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9002)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9002)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9002)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9002)), linetype="dashed", color = "blue") +
  ggtitle(label = "Darstellung der Heterogenität der Cluster") +
  ylab("Diabetes mellitus") + 
  xlab("Teil-Datensatz") +
  labs(col="Cluster")
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9003,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9003,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9003,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9003)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9003)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9003)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9003)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9003)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9003)), linetype="dashed", color = "blue") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9004,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9004,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9004,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9004)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9004)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9004)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9004)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9004)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9004)), linetype="dashed", color = "blue") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9005,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9005,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9005,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9005)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9005)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9005)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9005)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9005)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9005)), linetype="dashed", color = "blue") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9007,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9007,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9007,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9007)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9007)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9007)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9007)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9007)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9007)), linetype="dashed", color = "blue") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9008,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9008,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9008,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9008)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9008)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9008)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9008)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9008)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9008)), linetype="dashed", color = "blue")
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9009,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9009,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9009,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9009)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9009)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9009)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9009)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9009)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9009)), linetype="dashed", color = "blue") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9010,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9010,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9010,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9010)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9010)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9010)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9010)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9010)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9010)), linetype="dashed", color = "blue") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9011,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9011,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9011,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9011)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9011)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9011)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9011)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9011)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9011)), linetype="dashed", color = "blue") 
```


Nun mit 4 clustern

```{r}
cut = 4
cnt2_wrd <- matrix(c(1:(cut*20*39)),byrow=TRUE,nrow=(20*cut))
for (i in 1:20){
gower_cl_var <- daisy(cl_var_shuffled[(split[i]+1):split[i+1],],metric = c("gower"))
cluster_gower <- hclust(gower_cl_var, method = "ward.D")
#plot(cluster_gower,
#     main = "Agglomerative with complete linkages")
cluster_assignments <- cutree(cluster_gower,k=cut)

cl_var_clustered <- cl_var_shuffled[(split[i]+1):split[i+1],]
cl_var_clustered <- mutate(cl_var_clustered,cluster=cluster_assignments)

cnt_tmp <- cl_var_clustered %>%
group_by(cluster) %>%
summarise(count_cluster=length(alter),mean_alter=mean(alter,trim=0.025), mean_i9001=mean(i9001=="Ja"),mean_i9002=mean(i9002=="Ja"),mean_i9003=mean(i9003=="Ja"),mean_i9004=mean(i9004=="Ja"),mean_i9005=mean(i9005=="Ja"),mean_i9007=mean(i9007=="Ja"),mean_i9008=mean(i9008=="Ja"),mean_i9009=mean(i9009=="Ja"),mean_i9010=mean(i9010=="Ja"),mean_i9011=mean(i9011=="Ja"),mean_i9012=mean(i9012=="Ja"),mean_i10001=mean(i10001=="Ja"))  %>%
mutate(u_i9001 = confbound(mean_i9001,count_cluster,"upper"),l_i9001 = confbound(mean_i9001,count_cluster,"lower"),u_i9002 = confbound(mean_i9002,count_cluster,"upper"),l_i9002 = confbound(mean_i9002,count_cluster,"lower"),u_i9003 = confbound(mean_i9003,count_cluster,"upper"),l_i9003 = confbound(mean_i9003,count_cluster,"lower"),u_i9004 = confbound(mean_i9004,count_cluster,"upper"),l_i9004 = confbound(mean_i9004,count_cluster,"lower"),u_i9005 = confbound(mean_i9005,count_cluster,"upper"),l_i9005 = confbound(mean_i9005,count_cluster,"lower"),u_i9007 = confbound(mean_i9007,count_cluster,"upper"),l_i9007 = confbound(mean_i9007,count_cluster,"lower"),u_i9008 = confbound(mean_i9008,count_cluster,"upper"),l_i9008 = confbound(mean_i9008,count_cluster,"lower"),u_i9009 = confbound(mean_i9009,count_cluster,"upper"),l_i9009 = confbound(mean_i9009,count_cluster,"lower"),u_i9010 = confbound(mean_i9010,count_cluster,"upper"),l_i9010 = confbound(mean_i9010,count_cluster,"lower"),u_i9011 = confbound(mean_i9011,count_cluster,"upper"),l_i9011 = confbound(mean_i9011,count_cluster,"lower"),u_i9012 = confbound(mean_i9012,count_cluster,"upper"),l_i9012 = confbound(mean_i9012,count_cluster,"lower"),u_i10001 = confbound(mean_i10001,count_cluster,"upper"),l_i10001 = confbound(mean_i10001,count_cluster,"lower")) %>%
arrange(desc(mean_alter))
  
cnt2_wrd[4*i-3,]<-as.double(cnt_tmp[1,])
cnt2_wrd[4*i-2,]<-as.double(cnt_tmp[2,])
cnt2_wrd[4*i-1,]<-as.double(cnt_tmp[3,])
cnt2_wrd[4*i,]<-as.double(cnt_tmp[4,])
}
colnames(cnt2_wrd)<-names(cnt_tmp)
```
```{r}
cnt2_wrd_plus <- cbind(rep(c(1:20),each=4),rep(1:4,20),cnt2_wrd)
colnames(cnt2_wrd_plus) <-c("sample","cluster_sort",colnames(cnt2_wrd))
cnt2_wrd_plus[1:6,]
```


```{r}

p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9001,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9001,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9001)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9001)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9001)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9001)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9001)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9001)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9001)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9001)), linetype="dashed", color = "grey") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9002,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9002,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9002,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9002)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9002)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9002)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9002)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9002)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9002)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9002)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9002)), linetype="dashed", color = "grey") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9003,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9003,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9003,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9003)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9003)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9003)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9003)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9003)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9003)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9003)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9003)), linetype="dashed", color = "grey") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9004,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9004,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9004,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9004)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9004)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9004)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9004)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9004)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9004)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9004)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9004)), linetype="dashed", color = "grey") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9005,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9005,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9005,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9005)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9005)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9005)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9005)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9005)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9005)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9005)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9005)), linetype="dashed", color = "grey") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9007,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9007,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9007,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9007)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9007)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9007)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9007)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9007)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9007)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9007)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9007)), linetype="dashed", color = "grey") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9008,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9008,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9008,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9008)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9008)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9008)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9008)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9008)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9008)), linetype="dashed", color = "blue")+
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9008)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9008)), linetype="dashed", color = "grey") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9009,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9009,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9009,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9009)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9009)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9009)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9009)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9009)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9009)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9009)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9009)), linetype="dashed", color = "grey") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9010,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9010,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9010,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9010)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9010)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9010)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9010)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9010)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9010)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9010)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9010)), linetype="dashed", color = "grey") 
```


```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9011,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9011,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9011,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9011)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9011)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9011)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9011)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9011)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9011)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9011)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9011)), linetype="dashed", color = "grey") 
```

```{r}
p <- ggplot(cnt2_wrd_plus_df)
p+geom_point(aes(x = sample, y = u_i9012,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = l_i9012,color=factor(cluster_sort)))+geom_point(aes(x = sample, y = mean_i9012,color=factor(cluster_sort)))+
    geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(u_i9012)), linetype="dashed", color = "darkgreen") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==2)%>%select(l_i9012)), linetype="dashed", color = "green") +
      geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(u_i9012)), linetype="dashed", color = "darkred") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==1)%>%select(l_i9012)), linetype="dashed", color = "red") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(u_i9012)), linetype="dashed", color = "darkblue") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==3)%>%select(l_i9012)), linetype="dashed", color = "blue") +
        geom_hline(yintercept=min(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(u_i9012)), linetype="dashed", color = "darkgrey") +
      geom_hline(yintercept=max(cnt2_wrd_plus_df %>% filter(cluster_sort==4)%>%select(l_i9012)), linetype="dashed", color = "grey") 
```

#### Faktorenanalyse

Hierbei wurde wie bereits vorab erwähnt herausgefunden, dass die Variablen i9009-i9012 keinen signifikanten Faktor bilden und wurden somit nicht in die weitere FA inkludiert. Zudem wurden mehrere Formen der Altersvariable verglichen, beispielsweise als geordnete Kategorielle Variable, als one hot encodete Integer Variablen und als numerische Variablen, wobei als ordinale Altersvariable die signifikantesten Ergebnisse festestellt wurden.

##### Alter binär

In EFA und CFA set teilen

```{r}

cl_var_bin_alt_bin <- data.frame(sapply(cl_var_bin_clean,as.logical))
### entferne Id und eine Alter Variable (da redundant)
cl_var_bin_alt_bin = cl_var_bin_alt_bin[,-c(1,19)]

splitval = round(0.5*nrow(cl_var_bin_alt_bin))

bin_alt_bin_i0X <- cl_var_bin_alt_bin[,-c(9:12)]
bin_alt_bin_i1X <- cl_var_bin_alt_bin[,c(9:13)]

## i9001-i9008 und alter

alt_bin_i0X_efa <- bin_alt_bin_i0X[1:splitval,]
alt_bin_i0X_cfa <- bin_alt_bin_i0X[(splitval+1):nrow(bin_alt_bin_i0X),]

## i9009-i9012

alt_bin_i1X_efa <- bin_alt_bin_i1X[1:splitval,]
alt_bin_i1X_cfa <- bin_alt_bin_i1X[(splitval+1):nrow(bin_alt_bin_i0X),]

# alle Variablen

alt_bin_iXX_efa <- cl_var_bin_alt_bin[1:splitval,]
alt_bin_iXX_cfa <- cl_var_bin_alt_bin[(splitval +1):nrow(cl_var_bin_alt_bin),]


```


i9001-i9008 und alter Variable:

```{r}
cor_het_i0X_efa <-  hetcor(alt_bin_i0X_efa)$cor
#var_EFA_cor_bin <- cor(cl_var_bin_clean,use="pairwise.complete.obs")
scree(cor_het_i0X_efa,factors=FALSE)
```

```{r}
cor_het_i0X_cfa <- hetcor(alt_bin_i0X_cfa)$cor
CFA_model_i0X_cfa <- fa(r = cor_het_i0X_cfa, nfactors = 5, n.obs = nrow(alt_bin_i0X_cfa), rotate = "varimax")
CFA_model_i0X_cfa
```

Das Resultat ist ein negativer Tucker Lewis, und insignifikanter RMSEA Wert.  


i9009-i9012:

```{r}
cor_het_i1X_efa <-  hetcor(alt_bin_i1X_efa)$cor
#var_EFA_cor_bin <- cor(cl_var_bin_clean,use="pairwise.complete.obs")
scree(cor_het_i1X_efa,factors=FALSE)
```

```{r}
cor_het_i1X_cfa <- hetcor(alt_bin_i1X_cfa)$cor
CFA_model_i1X_cfa <- fa(r = cor_het_i1X_cfa, nfactors = 5, n.obs = nrow(alt_bin_i0X_cfa), rotate = "varimax")
CFA_model_i1X_cfa
```


Nicht signifikanter Tucker Lewis und RMSEA Wert.  


Alle Variablen:


```{r}
cor_het_iXX_efa <-  hetcor(alt_bin_iXX_efa)$cor
scree(cor_het_iXX_efa,factors=FALSE)
```

```{r}
cor_het_iXX_cfa <- hetcor(alt_bin_iXX_cfa)$cor
CFA_model_iXX_cfa <- fa(r = cor_het_iXX_cfa, nfactors = 6, n.obs = nrow(alt_bin_iXX_cfa), rotate = "varimax")
CFA_model_iXX_cfa
```

Nicht signifikanter Tucker Lewis und RMSEA Wert.


##### Alter quantitativ

```{r}
splitval = round(0.5*nrow(cl_var_bin_alt_cont))

bin_alt_cont_i0X <- cl_var_bin_alt_cont[,-c(9:12)]
bin_alt_cont_i1X <- cl_var_bin_alt_cont[,c(10:12)]

alt_cont_i0X_efa <- bin_alt_cont_i0X[1:splitval,-1]
alt_cont_i0X_cfa <- bin_alt_cont_i0X[splitval+1:nrow(bin_alt_cont_i0X),-1]

```
```{r}
cor_het_i0X_cont_efa <-  hetcor(alt_cont_i0X_efa)$cor
#var_EFA_cor_bin <- cor(cl_var_bin_clean,use="pairwise.complete.obs")
scree(cor_het_i0X_cont_efa,factors=FALSE)
```

```{r}
cor_het_i0X_cont_cfa <- hetcor(alt_cont_i0X_cfa)$cor
```
```{r}
CFA_model_i0X_cont_cfa <- fa(r = cor_het_i0X_cont_cfa, nfactors = 4, n.obs = nrow(alt_cont_i0X_cfa), rotate = "varimax")
CFA_model_i0X_cont_cfa 
```


